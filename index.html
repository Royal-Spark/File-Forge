<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>USAF File Forge</title>
<!-- Google Fonts for typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
 /* --- Visual Styles from Royal Spark Theme --- */
  :root {
    --bg-dark: #09090b;
    --card-bg: rgba(39, 39, 42, 0.5);
    --border-color: rgba(161, 161, 170, 0.2);
    --text-primary: #e4e4e7; /* zinc-200 */
    --text-secondary: #a1a1aa; /* zinc-400 */
    --primary-purple: #a855f7;
    --primary-cyan: #22d3ee;
    --accent-purple-muted: #c084fc;
    --input-bg: rgba(24, 24, 27, 0.7);
    --success: #22c55e;
    --error: #ef4444;
    --warning-yellow: #fbbf24;
  }

  html[data-theme='light'] {
    --bg-dark: #f4f4f5; /* zinc-100 */
    --card-bg: rgba(255, 255, 255, 0.8);
    --border-color: #d4d4d8; /* zinc-300 */
    --text-primary: #18181b; /* zinc-900 */
    --text-secondary: #52525b; /* zinc-600 */
    --input-bg: #e4e4e7; /* zinc-200 */
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
      scroll-behavior: smooth;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-dark);
    background-image: radial-gradient(ellipse at center, rgba(168, 85, 247, 0.1), transparent 70%);
    color: var(--text-primary);
    line-height: 1.5;
    position: relative;
    padding-top: 30px; /* Space for fixed banner */
    transition: background-color 0.3s, color 0.3s;
  }

  /* --- Fixed Warning Banner --- */
  .warning-banner {
    background: var(--warning-yellow);
    color: #000;
    text-align: center;
    padding: 6px;
    font-weight: 700;
    font-size: 0.8rem;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }

  /* --- Header --- */
  header {
    background: rgba(9, 9, 11, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border-color);
    padding: 0 1rem;
    position: sticky;
    top: 30px; /* Account for warning banner */
    z-index: 100;
  }
   html[data-theme='light'] header {
     background: rgba(255, 255, 255, 0.8);
   }

  .header-content {
    max-width: 1080px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 4rem;
  }
  .logo-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  h1 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, var(--text-primary), var(--accent-purple-muted));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }
   html[data-theme='light'] h1 {
     background: none;
     color: var(--text-primary);
   }
  .subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  /* Theme Toggle Button */
  .theme-toggle-btn {
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .theme-toggle-btn:hover {
    border-color: var(--primary-purple);
    color: var(--text-primary);
  }
  .theme-toggle-btn svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* --- Main Layout --- */
  main {
    max-width: 1080px;
    margin: 1rem auto;
    padding: 0 1rem 3rem;
    visibility: hidden;
  }
  main.unlocked {
      visibility: visible;
  }

  /* --- Tabs --- */
  .main-tabs-container {
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      text-align: center;
  }
  .main-tabs-container::-webkit-scrollbar { display: none; }
  .main-tabs {
    display: inline-flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
    padding: 0.25rem 0;
  }
  .main-tab {
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }
  .main-tab:hover {
    background: var(--input-bg);
    color: var(--text-primary);
  }
  .main-tab.active {
    background: linear-gradient(to right, var(--primary-purple), var(--primary-cyan));
    color: white;
    border-color: transparent;
  }
  .main-tab-content { display: none; }
  .main-tab-content.active { display: block; }
  
  /* --- Cards --- */
  .card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
  }
  .card:hover {
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 0 30px 4px rgba(168, 85, 247, 0.1);
  }
  html[data-theme='light'] .card:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  }
  .card h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-primary);
  }
  .step-badge {
    width: 36px;
    height: 36px;
    background: linear-gradient(to right, var(--primary-purple), var(--primary-cyan));
    border-radius: 30%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  .card p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  /* --- File Input --- */
  input[type="file"] {
    display: block;
    padding: 1rem;
    width: 100%;
    background: rgba(168, 85, 247, 0.05);
    border: 2px dashed var(--border-color);
    border-radius: 0.5rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  input[type="file"]:hover {
    background: rgba(168, 85, 247, 0.1);
    border-color: var(--primary-purple);
  }

  /* --- Buttons --- */
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    width: 100%;
  }
  .btn-primary {
    background: linear-gradient(to right, var(--primary-purple), var(--primary-cyan));
    color: white;
  }
  .btn-primary:hover:not(:disabled) {
    opacity: 0.9;
  }
  .btn-secondary {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
  }
  .btn-secondary:hover:not(:disabled) {
    background-color: rgba(39, 39, 42, 0.8);
  }
   html[data-theme='light'] .btn-secondary:hover:not(:disabled) {
     background-color: #e4e4e7;
   }
  .btn-restart {
    background: linear-gradient(135deg, #dc2626, #ef4444);
    color: white;
  }
  .btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .btn-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  /* --- Sub-Tabs --- */
  .sub-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    background: rgba(9, 9, 11, 0.5);
    padding: 0.25rem;
    border-radius: 0.5rem;
  }
   html[data-theme='light'] .sub-tabs {
     background: #e4e4e7;
   }
  .sub-tab {
    flex: 1;
    padding: 0.75rem 1rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .sub-tab.active {
    background: var(--input-bg);
    color: var(--text-primary);
  }
  html[data-theme='light'] .sub-tab.active {
    background: white;
  }
  .sub-tab-content { display: none; }
  .sub-tab-content.active { display: block; }

  /* --- Textareas and Inputs --- */
  textarea, input[type="text"], input[type="password"], select {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.2s ease;
    resize: vertical;
  }
  textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
    outline: none;
    border-color: var(--primary-purple);
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
  }
  .input-group { margin-bottom: 1.5rem; }
  .input-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  /* --- Code Blocks --- */
  pre {
    background: rgba(9, 9, 11, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    color: var(--accent-purple-muted);
    max-height: 300px;
    overflow-y: auto;
  }
  
  /* --- Alerts --- */
  .alert {
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    border: 1px solid transparent;
  }
  .alert-success {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.3);
    color: var(--success);
  }
   html[data-theme='light'] .alert-success {
     color: #15803d; /* green-700 */
   }
  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: var(--error);
  }
  html[data-theme='light'] .alert-error {
    color: #b91c1c; /* red-700 */
  }

  /* --- Manual Fields --- */
  .manual-fields {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  .manual-field {
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: rgba(9, 9, 11, 0.3);
    border-radius: 0.5rem;
  }
  html[data-theme='light'] .manual-field {
    background: #f4f4f5; /* zinc-100 */
  }
  .manual-field label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
  }
  .manual-field input {
    width: 100%;
    padding: 0.75rem;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.95rem;
  }
  
  /* --- Debug & Restart --- */
  .debug-panel {
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    margin-top: 2rem;
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--text-secondary);
    max-height: 150px;
    overflow-y: auto;
  }
  .restart-container {
    text-align: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  /* --- Modals --- */
  .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
  }
  .modal-content {
      background: #18181b; /* zinc-900 */
      padding: 2rem;
      border-radius: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 50px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
  }
   html[data-theme='light'] .modal-content {
     background: white;
   }
  .modal-overlay.visible .modal-content {
      transform: scale(1);
  }
  .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--text-primary);
  }
  .modal-content p {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
  }
  .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
  }
  .modal-buttons .btn {
      width: auto;
      flex: 1;
  }
  .password-error-msg {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 1rem;
      min-height: 1.2em;
      display: none;
  }
  .password-error-msg.visible {
      display: block;
  }

  /* --- Responsive Styles --- */
  @media (min-width: 768px) {
    h1 { font-size: 2.25rem; }
    .subtitle { font-size: 1.125rem; }
    .card { padding: 2rem; }
    .main-tab { padding: 0.75rem 2rem; }
    .btn-group { flex-direction: row; align-items: center; }
    .btn { width: auto; }
  }
</style>
</head>
<body>

<!-- Password Modal -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Beta Access</h3>
        <p>This tool is in beta testing. Please enter the password to continue.</p>
        <div class="input-group">
            <input type="password" id="passwordInput" placeholder="Enter password...">
        </div>
        <button id="passwordSubmitBtn" class="btn btn-primary">Enter</button>
        <div id="passwordError" class="password-error-msg"></div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle">Are you sure?</h3>
        <p id="modalMessage">This will clear all current data.</p>
        <div class="modal-buttons">
            <button id="modalCancelBtn" class="btn btn-secondary">Cancel</button>
            <button id="modalConfirmBtn" class="btn btn-restart">Confirm</button>
        </div>
    </div>
</div>

<!-- Warning Banner -->
<div class="warning-banner">
  THIS TOOL IS IN BETA TESTING - DO NOT INPUT CUI OR PII INTO THIS SYSTEM
</div>

<header>
  <div class="header-content">
    <a href="YOUR_LANDING_PAGE_URL_HERE" style="text-decoration: none;">
        <div class="logo-container">
            <img src="https://dwtymuzolmglgyejxuve.supabase.co/storage/v1/object/public/podcasts//Royal%20Spark%20D%20Logo%20-%20Mekvold%20V3.png" alt="Royal Spark Logo" style="height: 2.5rem; width: auto;">
            <span style="font-size: 1.25rem; font-weight: 700; background: linear-gradient(to right, var(--primary-purple), var(--primary-cyan)); -webkit-background-clip: text; background-clip: text; color: transparent; margin-left: 0.5rem;">Royal Spark</span>
        </div>
    </a>
    <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle theme">
        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.106a.75.75 0 0 1 0 1.06l-1.591 1.59a.75.75 0 1 1-1.06-1.06l1.59-1.59a.75.75 0 0 1 1.06 0ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM17.894 17.894a.75.75 0 0 1-1.06 0l-1.59-1.591a.75.75 0 1 1 1.06-1.06l1.59 1.59a.75.75 0 0 1 0 1.061ZM12 18.75a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0v-2.25a.75.75 0 0 1 .75-.75ZM5.106 17.894a.75.75 0 0 1 0-1.06l1.59-1.591a.75.75 0 1 1 1.06 1.06l-1.59 1.59a.75.75 0 0 1-1.06 0ZM4.5 12a.75.75 0 0 1-.75.75H1.5a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM6.106 5.106a.75.75 0 0 1 1.06 0l1.59 1.591a.75.75 0 0 1-1.06 1.06l-1.59-1.59a.75.75 0 0 1 0-1.061Z" /></svg>
        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.981A10.503 10.503 0 0 1 18 19.5a10.5 10.5 0 0 1-10.5-10.5A10.503 10.503 0 0 1 9.528 1.718Z" clip-rule="evenodd" /></svg>
    </button>
  </div>
</header>

<div style="text-align: center; margin-bottom: 2rem;">
    <h1>🛠️ USAF File Forge</h1>
    <div class="subtitle">Rapid Document Automation & Template Creation</div>
</div>

<main>
  <div class="main-tabs-container">
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('forge', this)">📄 File Forge</button>
        <button class="main-tab" onclick="switchMainTab('creator', this)">✨ Template Creator</button>
        <button class="main-tab" onclick="switchMainTab('placeholder', this)">🔧 Placeholder</button>
        <button class="main-tab" onclick="switchMainTab('placeholder2', this)">🔧 Placeholder 2</button>
    </div>
  </div>

  <!-- Main Tab: File Forge -->
  <div id="forgeTab" class="main-tab-content active">
    <div id="step1Card" class="card">
      <h2><span class="step-badge">1</span>Upload Document Template</h2>
      <p>Select a Word (.docx), PowerPoint (.pptx), Excel (.xlsx), or fillable PDF (.pdf) template.</p>
      <div class="file-input-wrapper">
        <input type="file" id="templateFile" accept=".docx,.pptx,.xlsx,.pdf" onchange="handleFileChange(event, 'forge')">
      </div>
      <div id="fileInfo"></div>
    </div>

    <div id="step2Card" class="card">
      <h2><span class="step-badge">2</span>Extract & Configure Placeholders</h2>
      <p>Placeholders (or PDF form fields) are automatically extracted. You can also re-scan manually.</p>
      <button onclick="extractPlaceholders()" id="extractBtn" class="btn btn-primary" disabled>
        🔍 Extract Placeholders
      </button>
      <div id="placeholdersOutput"></div>
      
      <div id="tabsContainer" style="display: none; margin-top: 2rem;">
        <div class="sub-tabs">
          <button class="sub-tab active" onclick="switchSubTab('ai', this)">🤖 AI Generation</button>
          <button class="sub-tab" onclick="switchSubTab('manual', this)">✏️ Manual Entry</button>
        </div>
        
        <div id="aiTab" class="sub-tab-content active">
          <div class="input-group">
            <label class="input-label">AI Instructions</label>
            <select id="forgePromptSelector"></select>
          </div>
          <div class="input-group">
            <label class="input-label">Provide the AI your data or context (Required)</label>
            <textarea id="aiContext" rows="4" placeholder="Provide details relevant to the template..."></textarea>
          </div>
          <div class="btn-group">
              <button onclick="generateAIPrompt()" id="generateAndCopyBtn" class="btn btn-primary">🎯 Generate & Copy Prompt</button>
              <a href="https://your-custom-url.com" class="btn btn-secondary" target="_blank">🚀 Open NIPR GPT</a>
           </div>
          <pre id="aiPromptOutput" style="display: none; margin-top: 1.5rem;"></pre>
          <div class="input-group" style="margin-top: 2rem;">
            <label class="input-label">Paste AI Response (JSON)</label>
            <textarea id="jsonDataInput" rows="10" placeholder='Paste JSON here...'></textarea>
          </div>
          <button onclick="fillTemplateFromAI()" class="btn btn-primary">✨ Fill Template & Download</button>
        </div>
        
        <div id="manualTab" class="sub-tab-content">
          <div id="manualFields" class="manual-fields"></div>
          <button onclick="fillTemplateFromManual()" class="btn btn-primary mt-4">✨ Generate Document</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Tab: Template Creator -->
  <div id="creatorTab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">1</span>Upload Completed Document</h2>
          <p>Select a completed Word (.docx), PowerPoint (.pptx), or Excel (.xlsx) file. (PDFs not supported).</p>
          <div class="file-input-wrapper">
              <input type="file" id="creatorFile" accept=".docx,.pptx,.xlsx" onchange="handleFileChange(event, 'creator')">
          </div>
          <div id="creatorFileInfo"></div>
      </div>

      <div class="card">
          <h2><span class="step-badge">2</span>Analyze & Generate Template</h2>
          <p>Review the extracted text, then generate a prompt for the AI to identify variables.</p>
          <div class="input-group">
            <label class="input-label">Extracted Document Text</label>
            <textarea id="creatorExtractedText" rows="10" placeholder="Text from your document will appear here..."></textarea>
          </div>
          
          <div class="btn-group">
            <button onclick="generateTemplateAIPrompt()" id="generateTemplatePromptBtn" class="btn btn-primary" disabled>
              🎯 Generate AI Prompt
            </button>
          </div>
          <pre id="creatorAIPromptOutput" style="display: none; margin-top: 1.5rem;"></pre>
          <div class="input-group" style="margin-top: 2rem;">
            <label class="input-label">Paste AI Response (JSON)</label>
            <textarea id="creatorJsonDataInput" rows="10" placeholder='Paste AI response here...'></textarea>
          </div>
          <button onclick="createTemplateFromAI()" id="createTemplateBtn" class="btn btn-primary" disabled>
            ✨ Create & Download Template
          </button>
      </div>
  </div>

  <!-- Main Tab: Placeholder -->
  <div id="placeholderTab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">?</span>Future Tool</h2>
          <p>This section is reserved for a future tool. Check back later for updates!</p>
      </div>
  </div>
  <!-- Main Tab: Placeholder 2 -->
   <div id="placeholder2Tab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">?</span>Future Tool 2</h2>
          <p>This section is reserved for a second future tool. Check back later for updates!</p>
      </div>
  </div>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div>🐛 Debug Output:</div>
    <div id="debugOutput"></div>
  </div>

  <!-- Restart Button -->
  <div class="restart-container">
    <button onclick="handleRestartClick()" class="btn btn-restart">
      🔄 Restart Tool
    </button>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
// --- THEME SWITCHER LOGIC ---
const themeToggleBtn = document.getElementById('theme-toggle');
const sunIcon = document.getElementById('sun-icon');
const moonIcon = document.getElementById('moon-icon');

function applyTheme(theme) {
    if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
    }
}

// Check for a saved theme in localStorage
const savedTheme = localStorage.getItem('theme');
// Check for the user's system preference
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

// Determine the initial theme
let initialTheme = 'dark'; // Default to dark
if (savedTheme) {
    initialTheme = savedTheme; // Use saved theme if it exists
} else {
    initialTheme = prefersDark ? 'dark' : 'light'; // Otherwise, use system preference
}

// Apply the determined theme on page load
applyTheme(initialTheme);

themeToggleBtn.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    applyTheme(newTheme);
});


// --- CUSTOM PROMPT CONFIGURATION ---
// Add or edit custom prompts for the "File Forge" workflow here.
const customForgePrompts = [
    {
        name: "Standard Content",
        text: "Please fill these placeholders with appropriate, professional content."
    },
    {
        "name": "100 ARW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 100th Air Refueling Wing mission. Detail the project's objective and how it enhances air refueling, combat support, or European theater operations. Specify key performance indicators, required resources (personnel, equipment, funding), a projected timeline with major milestones, and anticipated impact on readiness and mission effectiveness. Identify key stakeholders and potential risks."
    },
    {
        "name": "352 SOW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 352nd Special Operations Wing mission. Describe how the project supports special operations airpower, including infiltration, exfiltration, and precision strike capabilities. Outline the project scope, strategic objectives, required specialized assets, and integration with joint/partner forces. Detail the timeline, risk assessment, and how success will be measured in the context of special warfare."
    },
    {
        "name": "48 FW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 48th Fighter Wing mission. Explain how the project improves combat airpower, readiness, or support operations for the Liberty Wing. Define the project's goals, connection to F-15/F-35 operations, expected outcomes for sortie generation or lethality, required budget, personnel, and a clear timeline. Summarize the project's contribution to NATO objectives and air superiority."
    },
    {
        "name": "USAF Decoration Narrative",
        "text": "Write a formal narrative for a United States Air Force decoration. Detail the individual's specific, noteworthy achievement or service. Clearly describe the action, the outcome, and the significant impact on the unit's mission, personnel, or resources. Use strong, action-oriented language appropriate for a military citation. Focus on quantifiable results where possible."
    },
    {
        "name": "USAF Memorandum for Record (MFR)",
        "text": "Draft a concise, factual Memorandum for Record (MFR). State the purpose of the memorandum clearly in the opening. Document the key details of an event, decision, or conversation, including the date, time, location, and personnel involved. Present the information chronologically and objectively, without personal opinion or speculation. Conclude with any resulting actions or decisions made."
    },
    {
        "name": "USAF LOC/LOR/LOA",
        "text": "Generate the text for a formal Letter of Counseling, Admonishment, or Reprimand. Clearly state the specific infraction or unacceptable behavior and cite the relevant AFI, UCMJ article, or standard that was violated. Describe the negative impact of the action. Detail the required corrective actions the member must take and by what date. Include a statement that further deviation will result in more severe action."
    },
    {
        "name": "After Action Report",
        "text": "Generate an After Action Report (AAR) for a recent exercise, operation, or significant event. State the overall objectives. Provide a detailed summary of what occurred. Analyze what went well (sustains) and identify the root causes. Analyze what did not go well (improves) and identify the root causes. Provide specific, actionable recommendations for improvement, including responsible parties and proposed timelines for implementation."
    }
];
const customTemplatePrompts = [
    { 
        name: "Strict Analysis (Default)", 
        text: "Analyze the following document text. Your task is to identify all pieces of information that are variable and should be converted into placeholders. For each variable piece of information, you must: 1. Find the exact 'originalText' from the document. 2. Create a concise, descriptive, camelCase 'placeholderName' for it. Your final output must be ONLY a single, valid JSON array of objects, where each object contains an 'originalText' key and a 'placeholderName' key. Do not include any explanations, comments, or any text outside of the JSON array structure. Your entire response must be parsable as JSON." 
    }
];

// --- STATE MANAGEMENT ---
let forgeState = { fileBuffer: null, fileType: null, fileName: null, placeholders: [] };
let creatorState = { fileBuffer: null, fileType: null, fileName: null, fullText: '' };

// --- UTILITY FUNCTIONS ---
function debug(msg) {
  console.log(msg);
  const output = document.getElementById('debugOutput');
  if (output) {
    const time = new Date().toLocaleTimeString();
    output.innerHTML += `<div>[${time}] ${msg}</div>`;
    output.scrollTop = output.scrollHeight;
  }
}

function scrollToElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        setTimeout(() => {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function stripXmlTags(xmlString) {
    return xmlString.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
}
function xmlEncode(text) {
    if (typeof text !== 'string') return text;
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, '&apos;').replace(/"/g, '&quot;');
}

// --- INITIALIZATION & UI CONTROL ---
window.onload = function() {
  debug('Page loaded. Awaiting password.');
  setupModal();
  setupPasswordModal();
}

function populatePromptDropdowns() {
    const forgeSelector = document.getElementById('forgePromptSelector');
    forgeSelector.innerHTML = '';
    customForgePrompts.forEach((prompt, index) => {
        forgeSelector.add(new Option(prompt.name, index));
    });
    debug('Custom prompt dropdowns populated.');
}

// --- MODAL LOGIC ---
let confirmCallback = null;
function setupModal() {
    const modal = document.getElementById('customConfirmModal');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    
    cancelBtn.addEventListener('click', () => modal.classList.remove('visible'));
    
    confirmBtn.addEventListener('click', () => {
        if (typeof confirmCallback === 'function') confirmCallback();
        modal.classList.remove('visible');
    });
}

function setupPasswordModal() {
    const modal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const submitBtn = document.getElementById('passwordSubmitBtn');
    
    modal.classList.add('visible');
    passwordInput.focus();

    const checkPassword = () => {
        const errorMsg = document.getElementById('passwordError');
        if (passwordInput.value === 'theonetool') {
            modal.classList.remove('visible');
            document.querySelector('main').classList.add('unlocked');
            populatePromptDropdowns();
        } else {
            errorMsg.textContent = 'Incorrect password. Please try again.';
            errorMsg.classList.add('visible');
            passwordInput.value = '';
            passwordInput.focus();
        }
    };
    
    submitBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            checkPassword();
        }
    });
}

function showConfirm(title, message, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    confirmCallback = callback;
    document.getElementById('customConfirmModal').classList.add('visible');
}

function switchMainTab(tabName, button) {
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
    const tabContent = document.getElementById(tabName + 'Tab');
    if (tabContent) {
        tabContent.classList.add('active');
    }
    debug(`Switched to main tab: ${tabName}`);
}

function switchSubTab(tabName, button) {
  document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  button.classList.add('active');
  document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
  debug(`Switched to sub-tab: ${tabName}`);
}

function handleRestartClick() {
    showConfirm('Restart Tool?', 'This will clear all current data and reset the application.', restartTool);
}

function restartTool() {
    document.getElementById('templateFile').value = '';
    document.getElementById('creatorFile').value = '';
    forgeState = { fileBuffer: null, fileType: null, fileName: null, placeholders: [] };
    creatorState = { fileBuffer: null, fileType: null, fileName: null, fullText: '' };
    resetForgeUI();
    resetCreatorUI();
    document.getElementById('debugOutput').innerHTML = '';
    debug('Tool restarted');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetForgeUI() {
    document.getElementById('fileInfo').innerHTML = '';
    document.getElementById('extractBtn').disabled = true;
    document.getElementById('placeholdersOutput').innerHTML = '';
    document.getElementById('tabsContainer').style.display = 'none';
    document.getElementById('aiContext').value = '';
    document.getElementById('aiPromptOutput').textContent = '';
    document.getElementById('aiPromptOutput').style.display = 'none';
    document.getElementById('jsonDataInput').value = '';
    document.getElementById('manualFields').innerHTML = '';
    debug('File Forge UI reset');
}

function resetCreatorUI() {
    document.getElementById('creatorFileInfo').innerHTML = '';
    document.getElementById('creatorExtractedText').value = '';
    document.getElementById('generateTemplatePromptBtn').disabled = true;
    document.getElementById('creatorAIPromptOutput').style.display = 'none';
    document.getElementById('creatorJsonDataInput').value = '';
    document.getElementById('createTemplateBtn').disabled = true;
    debug('Template Creator UI reset');
}

// --- CORE LOGIC ---
function handleFileChange(event, mode) {
  const file = event.target.files[0];
  if (!file) return;

  const lowerName = file.name.toLowerCase();
  const fileType = lowerName.endsWith('.docx') ? 'docx' :
                   lowerName.endsWith('.pptx') ? 'pptx' :
                   lowerName.endsWith('.xlsx') ? 'xlsx' : 
                   lowerName.endsWith('.pdf')  ? 'pdf'  : null;

  const infoEl = document.getElementById(mode === 'forge' ? 'fileInfo' : 'creatorFileInfo');

  if (!fileType) {
    infoEl.innerHTML = `<div class="alert alert-error">❌ Please upload a supported file type.</div>`;
    return;
  }
  if (mode === 'creator' && fileType === 'pdf') {
      infoEl.innerHTML = '<div class="alert alert-error">❌ PDF files are not supported in Template Creator mode.</div>';
      return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    const fileBuffer = e.target.result;
    infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
    
    if (mode === 'forge') {
        resetForgeUI();
        infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
        forgeState = { ...forgeState, fileBuffer, fileType, fileName: file.name };
        document.getElementById('extractBtn').disabled = false;
        debug(`Forge file loaded: ${file.name}`);
        scrollToElement('step2Card');
        setTimeout(() => extractPlaceholders(), 100);
    } else if (mode === 'creator') {
        resetCreatorUI();
        infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
        creatorState = { ...creatorState, fileBuffer, fileType, fileName: file.name };
        debug(`Creator file loaded: ${file.name}`);
        setTimeout(() => extractAllText(), 100);
    }
  };
  reader.readAsArrayBuffer(file);
}

// --- FILE FORGE WORKFLOW ---
async function extractPlaceholders() {
  if (!forgeState.fileBuffer) return;
  debug('Extracting placeholders for Forge...');
  
  const output = document.getElementById('placeholdersOutput');
  const btn = document.getElementById('extractBtn');
  btn.disabled = true;

  try {
    const foundSet = new Set();
    if (forgeState.fileType === 'pdf') {
        const { PDFDocument } = PDFLib;
        const pdfDoc = await PDFDocument.load(forgeState.fileBuffer, { ignoreEncryption: true });
        const form = pdfDoc.getForm();
        form.getFields().forEach(field => foundSet.add(field.getName()));
    } else if (forgeState.fileType === 'xlsx') {
        const workbook = XLSX.read(forgeState.fileBuffer, {type: 'buffer'});
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            for (const cellAddress in sheet) {
                if (cellAddress[0] === '!') continue;
                const cell = sheet[cellAddress];
                if (cell && cell.t === 's' && cell.v) {
                    const matches = cell.v.match(/\{\{[^}]+\}\}/g) || [];
                    matches.forEach(m => foundSet.add(m.replace(/\{\{|\}\}/g, '').trim()));
                }
            }
        });
    } else { // docx and pptx
        const zip = await JSZip.loadAsync(forgeState.fileBuffer);
        const filesToScan = forgeState.fileType === 'docx' 
            ? ['word/document.xml'] 
            : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
        for (const fileName of filesToScan) {
            if (zip.files[fileName]) {
                const content = await zip.file(fileName).async('string');
                const matches = content.match(/\{\{[^}]+\}\}/g) || [];
                matches.forEach(m => foundSet.add(m.replace(/\{\{|\}\}/g, '').trim()));
            }
        }
    }
    
    forgeState.placeholders = Array.from(foundSet);
    debug(`Found ${forgeState.placeholders.length} placeholders: ${forgeState.placeholders.join(', ')}`);
    
    if (forgeState.placeholders.length === 0) {
      output.innerHTML = `<div class="alert alert-error">No placeholders or form fields found.</div>`;
      document.getElementById('tabsContainer').style.display = 'none';
    } else {
      output.innerHTML = `<div class="alert alert-success">✅ Found ${forgeState.placeholders.length} placeholders/fields.</div>`;
      document.getElementById('tabsContainer').style.display = 'block';
      setupManualFields();
      scrollToElement('tabsContainer');
    }
  } catch (error) {
    debug('Placeholder extraction error: ' + error.message);
    output.innerHTML = `<div class="alert alert-error">❌ Error: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
  }
}

function setupManualFields() {
  const container = document.getElementById('manualFields');
  container.innerHTML = '';
  forgeState.placeholders.forEach(p => {
    const div = document.createElement('div');
    div.className = 'manual-field';
    div.innerHTML = `<label>${p}</label><input type="text" id="manual_${p}" placeholder="Enter value for ${p}">`;
    container.appendChild(div);
  });
}

async function generateAIPrompt() {
  const selectedPromptIndex = document.getElementById('forgePromptSelector').value;
  const customText = customForgePrompts[selectedPromptIndex].text;
  const context = document.getElementById('aiContext').value;
  const prompt = `You will conduct market research, align goals, and format appropriately where necessary, while outputting a valid JSON object ONLY. No additional text or markdown. ${customText}\n\n${context} You must ONLY return a valid JSON object, replacing the placeholders with the relevant text you have output. \n\nPlaceholders to fill:\n${forgeState.placeholders.map(p => `- ${p}`).join('\n')}\n\nReturn as JSON:\n{\n${forgeState.placeholders.map(p => `  "${p}": "your content here"`).join(',\n')}\n}`;
  const promptOutput = document.getElementById('aiPromptOutput');
  promptOutput.textContent = prompt;
  // promptOutput.style.display = 'block'; // Commented out to hide prompt after copying
  try {
    await navigator.clipboard.writeText(prompt);
    const btn = document.getElementById('generateAndCopyBtn');
    btn.textContent = '✅ Copied!';
    setTimeout(() => { btn.textContent = '🎯 Generate & Copy Prompt'; }, 2500);
  } catch (err) {
    alert('Failed to copy prompt.');
  }
}

async function fillTemplate(data) {
  if (!forgeState.fileBuffer) return;
  debug('Filling template with data...');
  try {
    let blob;
    if (forgeState.fileType === 'pdf') {
        const { PDFDocument, PDFTextField, PDFCheckBox, PDFRadioGroup, PDFDropdown, PDFOptionList } = PDFLib;
        const pdfDoc = await PDFDocument.load(forgeState.fileBuffer, { ignoreEncryption: true });
        const form = pdfDoc.getForm();
        for (const [key, value] of Object.entries(data)) {
            try {
                const field = form.getField(key);
                if (field instanceof PDFTextField) { field.setText(value.toString()); }
                else if (field instanceof PDFCheckBox) { ['true', 'yes', 'on'].includes(value.toString().toLowerCase()) ? field.check() : field.uncheck(); }
                else if (field instanceof PDFRadioGroup) { field.select(value.toString()); }
                else if (field instanceof PDFDropdown || field instanceof PDFOptionList) { field.select(value.toString()); }
            } catch (e) {
                debug(`Could not find or fill PDF field: ${key}. Error: ${e.message}`);
            }
        }
        const pdfBytes = await pdfDoc.save();
        blob = new Blob([pdfBytes], { type: 'application/pdf' });
    } else if (forgeState.fileType === 'xlsx') {
        const workbook = XLSX.read(forgeState.fileBuffer, {type: 'buffer'});
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            for (const cellAddress in sheet) {
                if (cellAddress[0] === '!') continue;
                const cell = sheet[cellAddress];
                if (cell && cell.t === 's' && cell.v) {
                    for (const [key, value] of Object.entries(data)) {
                        const regex = new RegExp('\\{\\{\\s*' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\}\\}', 'g');
                        cell.v = cell.v.replace(regex, value || '');
                    }
                }
            }
        });
        const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
        blob = new Blob([wbout], {type: 'application/octet-stream'});
    } else { // docx and pptx
        const zip = await JSZip.loadAsync(forgeState.fileBuffer);
        const filesToScan = forgeState.fileType === 'docx' 
            ? ['word/document.xml'] 
            : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
        for (const fileName of filesToScan) {
            if (zip.files[fileName]) {
                let content = await zip.file(fileName).async('string');
                for (const [key, value] of Object.entries(data)) {
                    const regex = new RegExp('\\{\\{\\s*' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\}\\}', 'g');
                    content = content.replace(regex, xmlEncode(value));
                }
                zip.file(fileName, content);
            }
        }
        blob = await zip.generateAsync({type: 'blob'});
    }
    const outputName = forgeState.fileName.replace(/\.(docx|pptx|xlsx|pdf)$/, '_filled.$1');
    saveAs(blob, outputName);
    debug(`Document saved: ${outputName}`);
  } catch (error) {
    debug('Fill error: ' + error.message);
    alert('Error: ' + error.message);
  }
}

async function fillTemplateFromAI() {
  const jsonText = document.getElementById('jsonDataInput').value;
  try {
    const data = JSON.parse(jsonText);
    await fillTemplate(data);
  } catch (error) {
    alert('Invalid JSON: ' + error.message);
  }
}

async function fillTemplateFromManual() {
  const data = {};
  forgeState.placeholders.forEach(p => {
    const input = document.getElementById('manual_' + p);
    data[p] = input ? input.value : '';
  });
  await fillTemplate(data);
}

// --- TEMPLATE CREATOR WORKFLOW ---
async function extractAllText() {
    if (!creatorState.fileBuffer) return;
    debug('Extracting all text for Creator...');
    const textOutput = document.getElementById('creatorExtractedText');
    const btn = document.getElementById('generateTemplatePromptBtn');
    btn.disabled = true;
    textOutput.value = "Extracting...";
    try {
        let fullText = '';
        if (creatorState.fileType === 'xlsx') {
            const workbook = XLSX.read(creatorState.fileBuffer, { type: 'buffer' });
            const texts = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const sheetTexts = [];
                for (const cellAddress in sheet) {
                    if (cellAddress[0] === '!') continue;
                    const cell = sheet[cellAddress];
                    if (cell && cell.v) sheetTexts.push(cell.v);
                }
                texts.push(`--- Sheet: ${sheetName} ---\n${sheetTexts.join('\n')}`);
            });
            fullText = texts.join('\n\n');
        } else {
            const zip = await JSZip.loadAsync(creatorState.fileBuffer);
            const filesToScan = creatorState.fileType === 'docx' ? ['word/document.xml'] : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
            const texts = [];
            for (const fileName of filesToScan) {
                if (zip.files[fileName]) {
                    const content = await zip.file(fileName).async('string');
                    texts.push(stripXmlTags(content));
                }
            }
            fullText = texts.join('\n\n');
        }
        creatorState.fullText = fullText;
        textOutput.value = fullText;
        btn.disabled = false;
        document.getElementById('createTemplateBtn').disabled = false;
        debug('Full text extraction complete.');
    } catch (error) {
        debug('Full text extraction error: ' + error.message);
        textOutput.value = `Error extracting text: ${error.message}`;
    }
}
async function generateTemplateAIPrompt() {
    if (!creatorState.fullText) { alert('Please upload a document and extract its text first.'); return; }
    const customText = customTemplatePrompts[0].text;
    const prompt = `${customText}\n\nDocument Text to Analyze:\n---\n${creatorState.fullText}\n---`;
    const promptOutput = document.getElementById('creatorAIPromptOutput');
    promptOutput.textContent = prompt;
    // promptOutput.style.display = 'block'; // Commented out to hide prompt after copying
    try {
        await navigator.clipboard.writeText(prompt);
        const btn = document.getElementById('generateTemplatePromptBtn');
        btn.textContent = '✅ Copied!';
        debug('Template creator AI prompt generated and copied.');
        setTimeout(() => { btn.textContent = '🎯 Generate AI Prompt for Template'; }, 2500);
    } catch (err) { alert('Failed to copy prompt.'); debug('Copy failed: ' + err); }
}
async function createTemplateFromAI() {
    if (!creatorState.fileBuffer) { alert('Please upload a document first.'); return; }
    const jsonText = document.getElementById('creatorJsonDataInput').value;
    if (!jsonText) { alert('Please paste the AI JSON response.'); return; }
    let replacements;
    try {
        replacements = JSON.parse(jsonText);
        if (!Array.isArray(replacements)) throw new Error("JSON must be an array.");
    } catch (error) { alert('Invalid JSON: ' + error.message); return; }
    debug('Creating template from AI response...');
    try {
        let blob;
        if (creatorState.fileType === 'xlsx') {
            const workbook = XLSX.read(creatorState.fileBuffer, { type: 'buffer' });
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                for (const cellAddress in sheet) {
                    if (cellAddress[0] === '!') continue;
                    const cell = sheet[cellAddress];
                    if (cell && cell.t === 's' && cell.v) {
                        replacements.forEach(rep => {
                            if (cell.v.includes(rep.originalText)) {
                                cell.v = cell.v.replaceAll(rep.originalText, `{{${rep.placeholderName}}}`);
                            }
                        });
                    }
                }
            });
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            blob = new Blob([wbout], { type: 'application/octet-stream' });
        } else {
            const zip = await JSZip.loadAsync(creatorState.fileBuffer);
            const filesToScan = creatorState.fileType === 'docx' ? ['word/document.xml'] : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
            for (const fileName of filesToScan) {
                if (zip.files[fileName]) {
                    let content = await zip.file(fileName).async('string');
                    replacements.forEach(rep => {
                        const replacementValue = `{{${rep.placeholderName}}}`;
                        content = content.replaceAll(xmlEncode(rep.originalText), replacementValue);
                    });
                    zip.file(fileName, content);
                }
            }
            blob = await zip.generateAsync({ type: 'blob' });
        }
        const outputName = creatorState.fileName.replace(/\.(docx|pptx|xlsx)$/, '_template.$1');
        saveAs(blob, outputName);
        debug(`Template saved: ${outputName}`);
    } catch (error) {
        debug('Template creation error: ' + error.message);
        alert('Error creating template: ' + error.message);
    }
}
</script>
</body>
</html>

