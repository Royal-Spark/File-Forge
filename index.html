<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>USAF File Forge</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    /* Deep purple color scheme */
    --primary: #7c3aed;
    --primary-dark: #6d28d9;
    --secondary: #a855f7;
    --success: #10b981;
    --error: #ef4444;
    --bg-dark: #1a0033;
    --bg-light: #2d1b69;
    --card-bg: #2d1b69;
    --text-primary: #f1f5f9;
    --text-secondary: #c4b5fd;
    --border: #4c1d95;
    --accent: #e9d5ff;
    --warning-yellow: #fbbf24;
  }

  html {
      /* This enables smooth scrolling for anchor links and JS scrolling */
      scroll-behavior: smooth;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-primary);
    line-height: 1.5;
    min-height: 100vh;
    position: relative;
  }

  /* Warning Banner */
  .warning-banner {
    background: var(--warning-yellow);
    color: #000;
    text-align: center;
    padding: 6px;
    font-weight: 700;
    font-size: 0.8rem;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }

  /* Header */
  header {
    background: rgba(45, 27, 105, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px); /* Safari support */
    border-bottom: 1px solid var(--border);
    padding: 2rem 1rem; /* Adjusted padding for mobile */
    position: sticky;
    top: 30px; /* Account for warning banner */
    z-index: 100;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    margin-top: 30px; /* Push down for warning banner */
  }

  .header-content {
    max-width: 1080px;
    margin: 0 auto;
    padding: 0 1rem; /* Consistent padding */
    text-align: center;
  }

  h1 {
    font-size: 1.75rem; /* Reduced font size for mobile */
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--text-secondary);
    font-size: 1rem; /* Reduced font size for mobile */
  }

  /* Main layout */
  main {
    max-width: 1080px;
    margin: 1rem auto;
    padding: 0 1rem 3rem; /* Adjusted padding for mobile */
    visibility: hidden; /* Hide main content initially */
  }
  
  main.unlocked {
      visibility: visible;
  }

  /* Main App Tabs */
  .main-tabs-container {
      overflow-x: auto; /* Allows horizontal scrolling on mobile */
      white-space: nowrap;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      scrollbar-width: none; /* Hide scrollbar for Firefox */
  }
  .main-tabs-container::-webkit-scrollbar {
      display: none; /* Hide scrollbar for Chrome, Safari, Opera */
  }
  .main-tabs {
    display: inline-flex; /* Changed from flex to inline-flex for scrolling */
    justify-content: center;
    gap: 0.5rem; /* Reduced gap */
    margin-bottom: 2rem;
    padding: 0.25rem 0;
  }

  .main-tab {
    padding: 0.75rem 1.5rem; /* Adjusted padding */
    font-size: 1rem; /* Adjusted font size */
    font-weight: 600;
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0; /* Prevent tabs from shrinking */
  }
  
  .main-tab:hover {
    background: var(--bg-light);
    color: var(--text-primary);
  }

  .main-tab.active {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-color: var(--primary);
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
  }

  .main-tab-content { display: none; }
  .main-tab-content.active { display: block; }

  /* Cards */
  .card {
    background: rgba(45, 27, 105, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 1.5rem; /* Reduced padding for mobile */
    margin-bottom: 2rem;
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 40px rgba(124, 58, 237, 0.2);
  }

  .card h2 {
    font-size: 1.25rem; /* Reduced font size */
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem; /* Reduced gap */
    color: var(--text-primary);
  }

  .step-badge {
    width: 32px; /* Adjusted size */
    height: 32px; /* Adjusted size */
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius:30%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem; /* Adjusted font size */
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    flex-shrink: 0;
  }

  .card p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  /* File input */
  input[type="file"] {
    display: block;
    padding: 1rem;
    width: 100%;
    background: rgba(124, 58, 237, 0.1);
    border: 2px dashed rgba(124, 58, 237, 0.5);
    border-radius: 12px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  input[type="file"]:hover {
    background: rgba(124, 58, 237, 0.2);
    border-color: var(--primary);
  }

  /* Buttons */
  .btn {
    padding: 0.875rem 1.5rem; /* Adjusted padding */
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center; /* Center button content */
    gap: 0.5rem;
    text-decoration: none;
    width: 100%; /* Make buttons full width by default on mobile */
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
  }
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(124, 58, 237, 0.4);
  }
  .btn-secondary {
    background: rgba(196, 181, 253, 0.1);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover:not(:disabled) {
    background: rgba(196, 181, 253, 0.2);
  }
  .btn-restart {
    background: linear-gradient(135deg, #dc2626, #ef4444);
    color: white;
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
  }
  .btn-restart:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(239, 68, 68, 0.4);
  }
  .btn:disabled {
    opacity: 0.2;
    cursor: not-allowed;
  }

  /* Sub-Tabs (AI vs Manual) */
  .sub-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    background: rgba(26, 0, 51, 0.5);
    padding: 0.25rem;
    border-radius: 12px;
  }
  .sub-tab {
    flex: 1;
    padding: 0.75rem 1rem; /* Adjusted padding */
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 0.9rem; /* Adjusted font size */
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .sub-tab:hover { color: var(--text-primary); }
  .sub-tab.active {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
  }
  .sub-tab-content { display: none; }
  .sub-tab-content.active { display: block; }

  /* Textareas and inputs */
  textarea, input[type="text"], input[type="password"], select {
    width: 100%;
    padding: 1rem;
    background: rgba(26, 0, 51, 0.5);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    resize: vertical;
  }
  select { padding: 0.875rem; }
  textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(26, 0, 51, 0.8);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }
  .input-group { margin-bottom: 1.5rem; }
  .input-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
  }

  /* Code blocks */
  pre {
    background: rgba(26, 0, 51, 0.8);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem; /* Adjusted padding */
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem; /* Adjusted font size */
    line-height: 1.5;
    color: var(--accent);
    max-height: 300px; /* Adjusted max height */
    overflow-y: auto;
  }
  
  /* Alerts */
  .alert {
    padding: 1rem;
    border-radius: 12px;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
  }
  .alert-success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: var(--success);
  }
  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--error);
  }

  /* Manual fields */
  .manual-fields {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  .manual-field {
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: rgba(26, 0, 51, 0.3);
    border-radius: 12px;
  }
  .manual-field label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
  }
  .manual-field input {
    width: 100%;
    padding: 0.75rem;
    background: rgba(26, 0, 51, 0.8);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.95rem;
  }

  /* Button group */
  .btn-group {
    display: flex;
    flex-direction: column; /* Stack buttons vertically on mobile */
    gap: 1rem;
    margin-top: 1.5rem;
    align-items: stretch; /* Make buttons take full width */
  }

  /* Debug panel */
  .debug-panel {
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid var(--success);
    border-radius: 12px;
    padding: 1rem;
    margin-top: 2rem;
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--success);
    max-height: 150px;
    overflow-y: auto;
  }

  /* Restart button container */
  .restart-container {
    text-align: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
  }

  /* Custom Modals */
  .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
  }
  .modal-content {
      background: var(--bg-light);
      padding: 2rem;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 50px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
  }
  .modal-overlay.visible .modal-content {
      transform: scale(1);
  }
  .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--text-primary);
  }
  .modal-content p {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
  }
  .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
  }
  .modal-buttons .btn {
      width: auto; /* Override full-width for modal buttons */
      flex: 1;
  }
  .password-error-msg {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 1rem;
      min-height: 1.2em; /* Reserve space to prevent layout shift */
      display: none; /* Hidden by default */
  }
  .password-error-msg.visible {
      display: block;
  }


  /* Desktop and Tablet Styles */
  @media (min-width: 768px) {
    header {
        padding: 2rem 0;
    }
    h1 {
        font-size: 2.25rem;
    }
    .subtitle {
        font-size: 1.125rem;
    }
    main {
        padding: 0 2rem 3rem;
    }
    .card {
        padding: 2rem;
    }
    .card h2 {
        font-size: 1.5rem;
    }
    .main-tabs {
        gap: 1rem;
    }
    .main-tab {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }
    .btn-group {
        flex-direction: row;
        align-items: center;
    }
    .btn {
        width: auto; /* Buttons are not full width on desktop */
    }
  }
</style>
</head>
<body>

<!-- NEW: Password Modal -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Beta Access</h3>
        <p>This tool is in beta testing. Please enter the password to continue.</p>
        <div class="input-group">
            <input type="password" id="passwordInput" placeholder="Enter password...">
        </div>
        <button id="passwordSubmitBtn" class="btn btn-primary">Enter</button>
        <div id="passwordError" class="password-error-msg"></div>
    </div>
</div>


<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle">Are you sure?</h3>
        <p id="modalMessage">This will clear all current data.</p>
        <div class="modal-buttons">
            <button id="modalCancelBtn" class="btn btn-secondary">Cancel</button>
            <button id="modalConfirmBtn" class="btn btn-restart">Confirm</button>
        </div>
    </div>
</div>

<!-- Warning Banner -->
<div class="warning-banner">
  THIS TOOL IS IN BETA TESTING - DO NOT INPUT CUI OR PII INTO THIS SYSTEM
</div>

<header>
  <div class="header-content">
    <h1>🛠️ USAF File Forge</h1>
    <div class="subtitle">Rapid Document Automation & Template Creation</div>
  </div>
</header>

<main>
  <div class="main-tabs-container">
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('forge', this)">📄 File Forge</button>
        <button class="main-tab" onclick="switchMainTab('creator', this)">✨ Template Creator</button>
        <button class="main-tab" onclick="switchMainTab('placeholder', this)">🔧 Placeholder</button>
        <!-- FIXED: Corrected the onclick function call -->
        <button class="main-tab" onclick="switchMainTab('placeholder2', this)">🔧 Placeholder 2</button>
    </div>
  </div>

  <!-- Main Tab: File Forge -->
  <div id="forgeTab" class="main-tab-content active">
    <!-- Assigning IDs to cards for smooth scrolling -->
    <div id="step1Card" class="card">
      <h2><span class="step-badge">1</span>Upload Document Template</h2>
      <p>Select a Word (.docx), PowerPoint (.pptx), Excel (.xlsx), or fillable PDF (.pdf) template.</p>
      <div class="file-input-wrapper">
        <input type="file" id="templateFile" accept=".docx,.pptx,.xlsx,.pdf" onchange="handleFileChange(event, 'forge')">
      </div>
      <div id="fileInfo"></div>
    </div>

    <div id="step2Card" class="card">
      <h2><span class="step-badge">2</span>Extract & Configure Placeholders</h2>
      <p>Placeholders (or PDF form fields) are automatically extracted. You can also re-scan manually.</p>
      <button onclick="extractPlaceholders()" id="extractBtn" class="btn btn-primary" disabled>
        🔍 Extract Placeholders
      </button>
      <div id="placeholdersOutput"></div>
      
      <div id="tabsContainer" style="display: none; margin-top: 2rem;">
        <div class="sub-tabs">
          <button class="sub-tab active" onclick="switchSubTab('ai', this)">🤖 AI Generation</button>
          <button class="sub-tab" onclick="switchSubTab('manual', this)">✏️ Manual Entry</button>
        </div>
        
        <div id="aiTab" class="sub-tab-content active">
          <div class="input-group">
            <label class="input-label">AI Instructions</label>
            <select id="forgePromptSelector"></select>
          </div>
          <div class="input-group">
            <label class="input-label">Provide the AI your data or context (Required)</label>
            <textarea id="aiContext" rows="4" placeholder="Provide details relevant to the template..."></textarea>
          </div>
          <div class="btn-group">
              <button onclick="generateAIPrompt()" id="generateAndCopyBtn" class="btn btn-primary">🎯 Generate & Copy Prompt</button>
              <a href="https://your-custom-url.com" class="btn btn-primary" target="_blank">🚀 Open NIPR GPT</a>
           </div>
          <pre id="aiPromptOutput" style="display: none; margin-top: 1.5rem;"></pre>
          <div class="input-group" style="margin-top: 2rem;">
            <label class="input-label">Paste AI Response (JSON)</label>
            <textarea id="jsonDataInput" rows="10" placeholder='Paste JSON here...'></textarea>
          </div>
          <button onclick="fillTemplateFromAI()" class="btn btn-primary">✨ Fill Template & Download</button>
        </div>
        
        <div id="manualTab" class="sub-tab-content">
          <div id="manualFields" class="manual-fields"></div>
          <button onclick="fillTemplateFromManual()" class="btn btn-primary">✨ Generate Document</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Tab: Template Creator -->
  <div id="creatorTab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">1</span>Upload Completed Document</h2>
          <p>Select a completed Word (.docx), PowerPoint (.pptx), or Excel (.xlsx) file. (PDFs not supported).</p>
          <div class="file-input-wrapper">
              <input type="file" id="creatorFile" accept=".docx,.pptx,.xlsx" onchange="handleFileChange(event, 'creator')">
          </div>
          <div id="creatorFileInfo"></div>
      </div>

      <div class="card">
          <h2><span class="step-badge">2</span>Analyze & Generate Template</h2>
          <p>Review the extracted text, then generate a prompt for the AI to identify variables.</p>
          <div class="input-group">
            <label class="input-label">Extracted Document Text</label>
            <textarea id="creatorExtractedText" rows="10" placeholder="Text from your document will appear here..."></textarea>
          </div>
          
          <!-- REMOVED: Dropdown for AI Instructions is no longer needed -->

          <div class="btn-group">
            <button onclick="generateTemplateAIPrompt()" id="generateTemplatePromptBtn" class="btn btn-primary" disabled>
              🎯 Generate AI Prompt
            </button>
          </div>
          <pre id="creatorAIPromptOutput" style="display: none; margin-top: 1.5rem;"></pre>
          <div class="input-group" style="margin-top: 2rem;">
            <label class="input-label">Paste AI Response (JSON)</label>
            <textarea id="creatorJsonDataInput" rows="10" placeholder='Paste AI response here...'></textarea>
          </div>
          <button onclick="createTemplateFromAI()" id="createTemplateBtn" class="btn btn-primary" disabled>
            ✨ Create & Download Template
          </button>
      </div>
  </div>

  <!-- Main Tab: Placeholder -->
  <div id="placeholderTab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">?</span>Future Tool</h2>
          <p>This section is reserved for a future tool. Check back later for updates!</p>
      </div>
  </div>
  <!-- Main Tab: Placeholder 2 -->
  <!-- FIXED: Changed id to be unique -->
   <div id="placeholder2Tab" class="main-tab-content">
      <div class="card">
          <h2><span class="step-badge">?</span>Future Tool 2</h2>
          <p>This section is reserved for a second future tool. Check back later for updates!</p>
      </div>
  </div>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div>🐛 Debug Output:</div>
    <div id="debugOutput"></div>
  </div>

  <!-- Restart Button -->
  <div class="restart-container">
    <button onclick="handleRestartClick()" class="btn btn-restart">
      🔄 Restart Tool
    </button>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
// --- CUSTOM PROMPT CONFIGURATION ---
// Add or edit your custom prompts for the "File Forge" workflow here.
const customForgePrompts = [
    {
        name: "Standard Content",
        text: "Please fill these placeholders with appropriate, professional content."
    },
    {
        "name": "100 ARW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 100th Air Refueling Wing mission. Detail the project's objective and how it enhances air refueling, combat support, or European theater operations. Specify key performance indicators, required resources (personnel, equipment, funding), a projected timeline with major milestones, and anticipated impact on readiness and mission effectiveness. Identify key stakeholders and potential risks."
    },
    {
        "name": "352 SOW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 352nd Special Operations Wing mission. Describe how the project supports special operations airpower, including infiltration, exfiltration, and precision strike capabilities. Outline the project scope, strategic objectives, required specialized assets, and integration with joint/partner forces. Detail the timeline, risk assessment, and how success will be measured in the context of special warfare."
    },
    {
        "name": "48 FW Project One-Pager",
        "text": "Generate content for a project one-pager aligned with the 48th Fighter Wing mission. Explain how the project improves combat airpower, readiness, or support operations for the Liberty Wing. Define the project's goals, connection to F-15/F-35 operations, expected outcomes for sortie generation or lethality, required budget, personnel, and a clear timeline. Summarize the project's contribution to NATO objectives and air superiority."
    },
    {
        "name": "USAF Decoration Narrative",
        "text": "Write a formal narrative for a United States Air Force decoration. Detail the individual's specific, noteworthy achievement or service. Clearly describe the action, the outcome, and the significant impact on the unit's mission, personnel, or resources. Use strong, action-oriented language appropriate for a military citation. Focus on quantifiable results where possible."
    },
    {
        "name": "USAF Memorandum for Record (MFR)",
        "text": "Draft a concise, factual Memorandum for Record (MFR). State the purpose of the memorandum clearly in the opening. Document the key details of an event, decision, or conversation, including the date, time, location, and personnel involved. Present the information chronologically and objectively, without personal opinion or speculation. Conclude with any resulting actions or decisions made."
    },
    {
        "name": "USAF LOC/LOR/LOA",
        "text": "Generate the text for a formal Letter of Counseling, Admonishment, or Reprimand. Clearly state the specific infraction or unacceptable behavior and cite the relevant AFI, UCMJ article, or standard that was violated. Describe the negative impact of the action. Detail the required corrective actions the member must take and by what date. Include a statement that further deviation will result in more severe action."
    },
    {
        "name": "After Action Report",
        "text": "Generate an After Action Report (AAR) for a recent exercise, operation, or significant event. State the overall objectives. Provide a detailed summary of what occurred. Analyze what went well (sustains) and identify the root causes. Analyze what did not go well (improves) and identify the root causes. Provide specific, actionable recommendations for improvement, including responsible parties and proposed timelines for implementation."
    }
];
const customTemplatePrompts = [
    { 
        name: "Strict Analysis (Default)", 
        text: "Analyze the following document text. Your task is to identify all pieces of information that are variable and should be converted into placeholders. For each variable piece of information, you must: 1. Find the exact 'originalText' from the document. 2. Create a concise, descriptive, camelCase 'placeholderName' for it. Your final output must be ONLY a single, valid JSON array of objects, where each object contains an 'originalText' key and a 'placeholderName' key. Do not include any explanations, comments, or any text outside of the JSON array structure. Your entire response must be parsable as JSON." 
    }
];

// --- STATE MANAGEMENT ---
let forgeState = { fileBuffer: null, fileType: null, fileName: null, placeholders: [] };
let creatorState = { fileBuffer: null, fileType: null, fileName: null, fullText: '' };

// --- UTILITY FUNCTIONS ---
function debug(msg) {
  console.log(msg);
  const output = document.getElementById('debugOutput');
  if (output) {
    const time = new Date().toLocaleTimeString();
    output.innerHTML += `<div class="debug-line">[${time}] ${msg}</div>`;
    output.scrollTop = output.scrollHeight;
  }
}

function scrollToElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        setTimeout(() => {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function stripXmlTags(xmlString) {
    return xmlString.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
}
function xmlEncode(text) {
    if (typeof text !== 'string') return text;
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, '&apos;').replace(/"/g, '&quot;');
}

// --- INITIALIZATION & UI CONTROL ---
window.onload = function() {
  debug('Page loaded. Awaiting password.');
  setupModal();
  setupPasswordModal();
}

function populatePromptDropdowns() {
    const forgeSelector = document.getElementById('forgePromptSelector');
    customForgePrompts.forEach((prompt, index) => {
        forgeSelector.add(new Option(prompt.name, index));
    });
    // REMOVED: No longer need to populate the creator prompt dropdown
    debug('Custom prompt dropdowns populated.');
}

// --- MODAL LOGIC ---
let confirmCallback = null;
function setupModal() {
    const modal = document.getElementById('customConfirmModal');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    
    cancelBtn.addEventListener('click', () => modal.classList.remove('visible'));
    
    confirmBtn.addEventListener('click', () => {
        if (typeof confirmCallback === 'function') confirmCallback();
        modal.classList.remove('visible');
    });
}

function setupPasswordModal() {
    const modal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const submitBtn = document.getElementById('passwordSubmitBtn');
    
    modal.classList.add('visible'); // Show password modal on load
    passwordInput.focus(); // FIXED: Set focus to the password input

    const checkPassword = () => {
        const errorMsg = document.getElementById('passwordError');
        if (passwordInput.value === 'theonetool') {
            modal.classList.remove('visible');
            document.querySelector('main').classList.add('unlocked');
            // Initialize the rest of the app
            debug('Password correct. Initializing app.');
            populatePromptDropdowns();
        } else {
            errorMsg.textContent = 'Incorrect password. Please try again.';
            errorMsg.classList.add('visible');
            passwordInput.value = '';
            passwordInput.focus();
        }
    };
    
    submitBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            checkPassword();
        }
    });
}

function showConfirm(title, message, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    confirmCallback = callback;
    document.getElementById('customConfirmModal').classList.add('visible');
}

function switchMainTab(tabName, button) {
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    button.classList.add('active');
    document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
    // This line was causing the error because it couldn't find an element with a duplicate ID
    const tabContent = document.getElementById(tabName + 'Tab');
    if (tabContent) {
        tabContent.classList.add('active');
    }
    debug(`Switched to main tab: ${tabName}`);
}

function switchSubTab(tabName, button) {
  document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  button.classList.add('active');
  document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
  debug(`Switched to sub-tab: ${tabName}`);
}

function handleRestartClick() {
    showConfirm('Restart Tool?', 'This will clear all current data and reset the application.', restartTool);
}

function restartTool() {
    document.getElementById('templateFile').value = '';
    document.getElementById('creatorFile').value = '';
    forgeState = { fileBuffer: null, fileType: null, fileName: null, placeholders: [] };
    creatorState = { fileBuffer: null, fileType: null, fileName: null, fullText: '' };
    resetForgeUI();
    resetCreatorUI();
    document.getElementById('debugOutput').innerHTML = '';
    debug('Tool restarted');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetForgeUI() {
    document.getElementById('fileInfo').innerHTML = '';
    document.getElementById('extractBtn').disabled = true;
    document.getElementById('placeholdersOutput').innerHTML = '';
    document.getElementById('tabsContainer').style.display = 'none';
    document.getElementById('aiContext').value = '';
    document.getElementById('aiPromptOutput').textContent = '';
    document.getElementById('aiPromptOutput').style.display = 'none';
    document.getElementById('jsonDataInput').value = '';
    document.getElementById('manualFields').innerHTML = '';
    debug('File Forge UI reset');
}

function resetCreatorUI() {
    document.getElementById('creatorFileInfo').innerHTML = '';
    document.getElementById('creatorExtractedText').value = '';
    document.getElementById('generateTemplatePromptBtn').disabled = true;
    document.getElementById('creatorAIPromptOutput').style.display = 'none';
    document.getElementById('creatorJsonDataInput').value = '';
    document.getElementById('createTemplateBtn').disabled = true;
    debug('Template Creator UI reset');
}

// --- CORE LOGIC ---
function handleFileChange(event, mode) {
  const file = event.target.files[0];
  if (!file) return;

  const lowerName = file.name.toLowerCase();
  const fileType = lowerName.endsWith('.docx') ? 'docx' :
                   lowerName.endsWith('.pptx') ? 'pptx' :
                   lowerName.endsWith('.xlsx') ? 'xlsx' : 
                   lowerName.endsWith('.pdf')  ? 'pdf'  : null;

  const infoEl = document.getElementById(mode === 'forge' ? 'fileInfo' : 'creatorFileInfo');

  if (!fileType) {
    infoEl.innerHTML = `<div class="alert alert-error">❌ Please upload a supported file type.</div>`;
    return;
  }
  if (mode === 'creator' && fileType === 'pdf') {
      infoEl.innerHTML = '<div class="alert alert-error">❌ PDF files are not supported in Template Creator mode.</div>';
      return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    const fileBuffer = e.target.result;
    infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
    
    if (mode === 'forge') {
        resetForgeUI();
        infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
        forgeState = { ...forgeState, fileBuffer, fileType, fileName: file.name };
        document.getElementById('extractBtn').disabled = false;
        debug(`Forge file loaded: ${file.name}`);
        scrollToElement('step2Card');
        setTimeout(() => extractPlaceholders(), 100);
    } else if (mode === 'creator') {
        resetCreatorUI();
        infoEl.innerHTML = `<div class="alert alert-success">✅ ${file.name} loaded</div>`;
        creatorState = { ...creatorState, fileBuffer, fileType, fileName: file.name };
        debug(`Creator file loaded: ${file.name}`);
        setTimeout(() => extractAllText(), 100);
    }
  };
  reader.readAsArrayBuffer(file);
}

// --- FILE FORGE WORKFLOW ---
async function extractPlaceholders() {
  if (!forgeState.fileBuffer) return;
  debug('Extracting placeholders for Forge...');
  
  const output = document.getElementById('placeholdersOutput');
  const btn = document.getElementById('extractBtn');
  btn.disabled = true;

  try {
    const foundSet = new Set();
    if (forgeState.fileType === 'pdf') {
        const { PDFDocument } = PDFLib;
        const pdfDoc = await PDFDocument.load(forgeState.fileBuffer, { ignoreEncryption: true });
        const form = pdfDoc.getForm();
        form.getFields().forEach(field => foundSet.add(field.getName()));
    } else if (forgeState.fileType === 'xlsx') {
        const workbook = XLSX.read(forgeState.fileBuffer, {type: 'buffer'});
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            for (const cellAddress in sheet) {
                if (cellAddress[0] === '!') continue;
                const cell = sheet[cellAddress];
                if (cell && cell.t === 's' && cell.v) {
                    const matches = cell.v.match(/\{\{[^}]+\}\}/g) || [];
                    matches.forEach(m => foundSet.add(m.replace(/\{\{|\}\}/g, '').trim()));
                }
            }
        });
    } else { // docx and pptx
        const zip = await JSZip.loadAsync(forgeState.fileBuffer);
        const filesToScan = forgeState.fileType === 'docx' 
            ? ['word/document.xml'] 
            : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
        for (const fileName of filesToScan) {
            if (zip.files[fileName]) {
                const content = await zip.file(fileName).async('string');
                const matches = content.match(/\{\{[^}]+\}\}/g) || [];
                matches.forEach(m => foundSet.add(m.replace(/\{\{|\}\}/g, '').trim()));
            }
        }
    }
    
    forgeState.placeholders = Array.from(foundSet);
    debug(`Found ${forgeState.placeholders.length} placeholders: ${forgeState.placeholders.join(', ')}`);
    
    if (forgeState.placeholders.length === 0) {
      output.innerHTML = `<div class="alert alert-error">No placeholders or form fields found.</div>`;
      document.getElementById('tabsContainer').style.display = 'none';
    } else {
      output.innerHTML = `<div class="alert alert-success">✅ Found ${forgeState.placeholders.length} placeholders/fields.</div>`;
      document.getElementById('tabsContainer').style.display = 'block';
      setupManualFields();
      scrollToElement('tabsContainer');
    }
  } catch (error) {
    debug('Placeholder extraction error: ' + error.message);
    output.innerHTML = `<div class="alert alert-error">❌ Error: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
  }
}

function setupManualFields() {
  const container = document.getElementById('manualFields');
  container.innerHTML = '';
  forgeState.placeholders.forEach(p => {
    const div = document.createElement('div');
    div.className = 'manual-field';
    div.innerHTML = `<label>${p}</label><input type="text" id="manual_${p}" placeholder="Enter value for ${p}">`;
    container.appendChild(div);
  });
}

async function generateAIPrompt() {
  const selectedPromptIndex = document.getElementById('forgePromptSelector').value;
  const customText = customForgePrompts[selectedPromptIndex].text;
  const context = document.getElementById('aiContext').value;
  const prompt = `${customText}\n\n${context}\n\nPlaceholders to fill:\n${forgeState.placeholders.map(p => `- ${p}`).join('\n')}\n\nReturn as JSON:\n{\n${forgeState.placeholders.map(p => `  "${p}": "your content here"`).join(',\n')}\n}`;
  const promptOutput = document.getElementById('aiPromptOutput');
  promptOutput.textContent = prompt;
  try {
    await navigator.clipboard.writeText(prompt);
    const btn = document.getElementById('generateAndCopyBtn');
    btn.textContent = '✅ Copied!';
    setTimeout(() => { btn.textContent = '🎯 Generate & Copy Prompt'; }, 2500);
  } catch (err) {
    alert('Failed to copy prompt.');
  }
}

async function fillTemplate(data) {
  if (!forgeState.fileBuffer) return;
  debug('Filling template with data...');
  try {
    let blob;
    if (forgeState.fileType === 'pdf') {
        const { PDFDocument, PDFTextField, PDFCheckBox, PDFRadioGroup, PDFDropdown, PDFOptionList } = PDFLib;
        const pdfDoc = await PDFDocument.load(forgeState.fileBuffer, { ignoreEncryption: true });
        const form = pdfDoc.getForm();
        for (const [key, value] of Object.entries(data)) {
            try {
                const field = form.getField(key);
                if (field instanceof PDFTextField) { field.setText(value.toString()); }
                else if (field instanceof PDFCheckBox) { ['true', 'yes', 'on'].includes(value.toString().toLowerCase()) ? field.check() : field.uncheck(); }
                else if (field instanceof PDFRadioGroup) { field.select(value.toString()); }
                else if (field instanceof PDFDropdown || field instanceof PDFOptionList) { field.select(value.toString()); }
            } catch (e) {
                debug(`Could not find or fill PDF field: ${key}. Error: ${e.message}`);
            }
        }
        const pdfBytes = await pdfDoc.save();
        blob = new Blob([pdfBytes], { type: 'application/pdf' });
    } else if (forgeState.fileType === 'xlsx') {
        const workbook = XLSX.read(forgeState.fileBuffer, {type: 'buffer'});
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            for (const cellAddress in sheet) {
                if (cellAddress[0] === '!') continue;
                const cell = sheet[cellAddress];
                if (cell && cell.t === 's' && cell.v) {
                    for (const [key, value] of Object.entries(data)) {
                        const regex = new RegExp('\\{\\{\\s*' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\}\\}', 'g');
                        cell.v = cell.v.replace(regex, value || '');
                    }
                }
            }
        });
        const wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
        blob = new Blob([wbout], {type: 'application/octet-stream'});
    } else { // docx and pptx
        const zip = await JSZip.loadAsync(forgeState.fileBuffer);
        const filesToScan = forgeState.fileType === 'docx' 
            ? ['word/document.xml'] 
            : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
        for (const fileName of filesToScan) {
            if (zip.files[fileName]) {
                let content = await zip.file(fileName).async('string');
                for (const [key, value] of Object.entries(data)) {
                    const regex = new RegExp('\\{\\{\\s*' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\}\\}', 'g');
                    content = content.replace(regex, xmlEncode(value));
                }
                zip.file(fileName, content);
            }
        }
        blob = await zip.generateAsync({type: 'blob'});
    }
    const outputName = forgeState.fileName.replace(/\.(docx|pptx|xlsx|pdf)$/, '_filled.$1');
    saveAs(blob, outputName);
    debug(`Document saved: ${outputName}`);
  } catch (error) {
    debug('Fill error: ' + error.message);
    alert('Error: ' + error.message);
  }
}

async function fillTemplateFromAI() {
  const jsonText = document.getElementById('jsonDataInput').value;
  try {
    const data = JSON.parse(jsonText);
    await fillTemplate(data);
  } catch (error) {
    alert('Invalid JSON: ' + error.message);
  }
}

async function fillTemplateFromManual() {
  const data = {};
  forgeState.placeholders.forEach(p => {
    const input = document.getElementById('manual_' + p);
    data[p] = input ? input.value : '';
  });
  await fillTemplate(data);
}

// --- TEMPLATE CREATOR WORKFLOW ---
async function extractAllText() {
    if (!creatorState.fileBuffer) return;
    debug('Extracting all text for Creator...');
    const textOutput = document.getElementById('creatorExtractedText');
    const btn = document.getElementById('generateTemplatePromptBtn');
    btn.disabled = true;
    textOutput.value = "Extracting...";
    try {
        let fullText = '';
        if (creatorState.fileType === 'xlsx') {
            const workbook = XLSX.read(creatorState.fileBuffer, { type: 'buffer' });
            const texts = [];
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const sheetTexts = [];
                for (const cellAddress in sheet) {
                    if (cellAddress[0] === '!') continue;
                    const cell = sheet[cellAddress];
                    if (cell && cell.v) sheetTexts.push(cell.v);
                }
                texts.push(`--- Sheet: ${sheetName} ---\n${sheetTexts.join('\n')}`);
            });
            fullText = texts.join('\n\n');
        } else {
            const zip = await JSZip.loadAsync(creatorState.fileBuffer);
            const filesToScan = creatorState.fileType === 'docx' ? ['word/document.xml'] : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
            const texts = [];
            for (const fileName of filesToScan) {
                if (zip.files[fileName]) {
                    const content = await zip.file(fileName).async('string');
                    texts.push(stripXmlTags(content));
                }
            }
            fullText = texts.join('\n\n');
        }
        creatorState.fullText = fullText;
        textOutput.value = fullText;
        btn.disabled = false;
        document.getElementById('createTemplateBtn').disabled = false;
        debug('Full text extraction complete.');
    } catch (error) {
        debug('Full text extraction error: ' + error.message);
        textOutput.value = `Error extracting text: ${error.message}`;
    }
}
async function generateTemplateAIPrompt() {
    if (!creatorState.fullText) { alert('Please upload a document and extract its text first.'); return; }
    // UPDATED: Directly use the first (and only) prompt
    const customText = customTemplatePrompts[0].text;
    const prompt = `${customText}\n\nDocument Text to Analyze:\n---\n${creatorState.fullText}\n---`;
    const promptOutput = document.getElementById('creatorAIPromptOutput');
    promptOutput.textContent = prompt;
    promptOutput.style.display = 'block';
    try {
        await navigator.clipboard.writeText(prompt);
        const btn = document.getElementById('generateTemplatePromptBtn');
        btn.textContent = '✅ Copied!';
        debug('Template creator AI prompt generated and copied.');
        setTimeout(() => { btn.textContent = '🎯 Generate AI Prompt for Template'; }, 2500);
    } catch (err) { alert('Failed to copy prompt.'); debug('Copy failed: ' + err); }
}
async function createTemplateFromAI() {
    if (!creatorState.fileBuffer) { alert('Please upload a document first.'); return; }
    const jsonText = document.getElementById('creatorJsonDataInput').value;
    if (!jsonText) { alert('Please paste the AI JSON response.'); return; }
    let replacements;
    try {
        replacements = JSON.parse(jsonText);
        if (!Array.isArray(replacements)) throw new Error("JSON must be an array.");
    } catch (error) { alert('Invalid JSON: ' + error.message); return; }
    debug('Creating template from AI response...');
    try {
        let blob;
        if (creatorState.fileType === 'xlsx') {
            const workbook = XLSX.read(creatorState.fileBuffer, { type: 'buffer' });
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                for (const cellAddress in sheet) {
                    if (cellAddress[0] === '!') continue;
                    const cell = sheet[cellAddress];
                    if (cell && cell.t === 's' && cell.v) {
                        replacements.forEach(rep => {
                            if (cell.v.includes(rep.originalText)) {
                                cell.v = cell.v.replaceAll(rep.originalText, `{{${rep.placeholderName}}}`);
                            }
                        });
                    }
                }
            });
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            blob = new Blob([wbout], { type: 'application/octet-stream' });
        } else {
            const zip = await JSZip.loadAsync(creatorState.fileBuffer);
            const filesToScan = creatorState.fileType === 'docx' ? ['word/document.xml'] : Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/') && name.endsWith('.xml'));
            for (const fileName of filesToScan) {
                if (zip.files[fileName]) {
                    let content = await zip.file(fileName).async('string');
                    replacements.forEach(rep => {
                        const replacementValue = `{{${rep.placeholderName}}}`;
                        content = content.replaceAll(xmlEncode(rep.originalText), replacementValue);
                    });
                    zip.file(fileName, content);
                }
            }
            blob = await zip.generateAsync({ type: 'blob' });
        }
        const outputName = creatorState.fileName.replace(/\.(docx|pptx|xlsx)$/, '_template.$1');
        saveAs(blob, outputName);
        debug(`Template saved: ${outputName}`);
    } catch (error) {
        debug('Template creation error: ' + error.message);
        alert('Error creating template: ' + error.message);
    }
}
</script>
</body>
</html>

